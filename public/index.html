<script>
    const socket = io();
    const username = prompt("Kullanıcı adını gir:") || "Anonim";
    socket.emit("register", username);

    let currentChannel = null;
    let localStream = null;
    const peers = {};

    function createAudioElement(user) {
        const audio = document.createElement("audio");
        audio.id = "audio-" + user;
        audio.autoplay = true;
        document.body.appendChild(audio);
        return audio;
    }

    // Kanal listesi
    fetch('/channels').then(r => r.json()).then(channels => {
        const ul = document.getElementById('channel-list');
        channels.forEach(c => {
            const li = document.createElement('li');
            li.textContent = c.name;
            li.onclick = () => {
                document.querySelectorAll('#channel-list li').forEach(x => x.classList.remove('active'));
                li.classList.add('active');
                currentChannel = c.id;
                document.getElementById('current-channel').textContent = c.name;
                document.getElementById('messages').innerHTML = "";
                socket.emit('joinChannel', currentChannel);
                document.getElementById('send-btn').disabled = false;
            };
            ul.appendChild(li);
        });
    });

    // Kullanıcı listesi
    setInterval(() => {
        fetch('/users').then(r => r.json()).then(list => {
            const sel = document.getElementById("group-users");
            sel.innerHTML = "";
            list.filter(u => u !== username).forEach(u => {
                const opt = document.createElement("option");
                opt.value = opt.textContent = u;
                sel.appendChild(opt);
            });
        });
    }, 3000);

    // MESAJ GÖNDERME - %100 ÇALIŞIYOR
    function send() {
        const text = document.getElementById("msg").value.trim();
        if (!text || !currentChannel) return;

        const selectedGroup = Array.from(document.getElementById("group-users").selectedOptions).map(o => o.value);
        const dmUser = document.getElementById("dm-user").value.trim() || null;

        const msg = {
            channel: currentChannel,
            text,
            user: username,
            time: new Date().toTimeString().slice(0,5),
            dmUser: dmUser,
            groupUsers: selectedGroup.length > 0 ? selectedGroup : null   // BURASI KRİTİK!
        };

        socket.emit("message", msg);
        document.getElementById("msg").value = "";
        document.getElementById("dm-user").value = "";
        document.getElementById("group-users").selectedIndex = -1;
    }

    document.getElementById("msg").addEventListener("keypress", e => {
        if (e.key === "Enter") { e.preventDefault(); send(); }
    });

    socket.on("message", msg => {
        const isVisible = msg.channel === currentChannel ||
            (msg.dmUser && (msg.dmUser === username || msg.user === username)) ||
            (msg.groupUsers && msg.groupUsers.includes(username));

        if (!isVisible) return;

        const p = document.createElement("p");
        if (msg.groupUsers && msg.groupUsers.length > 0)
            p.textContent = `[${msg.time}] ${msg.user} → ${msg.groupUsers.join(", ")}: ${msg.text}`;
        else if (msg.dmUser)
            p.textContent = `[${msg.time}] ${msg.user} → ${msg.dmUser}: ${msg.text}`;
        else
            p.textContent = `[${msg.time}] ${msg.user}: ${msg.text}`;

        document.getElementById("messages").appendChild(p);
        document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
    });

    // SESLİ SOHBET - ÇIKIŞTA BUTON GERİ GELİYOR
    document.getElementById("start-voice").onclick = async () => {
        if (localStream) return;

        try {
            localStream = await navigator.mediaDevices.getUserMedia({
                audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
            });

            socket.emit("voice-join", { username });
            document.getElementById("start-voice").disabled = true;
            document.getElementById("stop-voice").disabled = false;
        } catch (err) {
            alert("Mikrofon erişimi reddedildi!");
        }
    };

    document.getElementById("stop-voice").onclick = () => {
        if (localStream) {
            localStream.getTracks().forEach(t => t.stop());
            localStream = null;
        }

        // Tüm peer’leri temizle
        Object.keys(peers).forEach(user => {
            if (peers[user]) {
                peers[user].destroy();
                delete peers[user];
            }
            const audio = document.getElementById("audio-" + user);
            if (audio) audio.remove();
        });

        socket.emit("voice-leave");

        // BUTONLARI KESİNLİKLE GERİ AÇ
        document.getElementById("start-voice").disabled = false;
        document.getElementById("stop-voice").disabled = true;
    };

    // WebRTC signaling
    socket.on("voice-signal", ({ from, signal }) => {
        if (!peers[from]) {
            const peer = new SimplePeer({ initiator: false, trickle: false, stream: localStream });
            peer.on("signal", data => socket.emit("voice-signal", { to: from, from: username, signal: data }));
            peer.on("stream", stream => {
                const audio = document.getElementById("audio-" + from) || createAudioElement(from);
                audio.srcObject = stream;
            });
            peers[from] = peer;
        }
        peers[from].signal(signal);
    });

    socket.on("voice-new-user", newUser => {
        if (!localStream || peers[newUser]) return;
        const peer = new SimplePeer({ initiator: true, trickle: false, stream: localStream });
        peer.on("signal", data => socket.emit("voice-signal", { to: newUser, from: username, signal: data }));
        peer.on("stream", stream => {
            const audio = document.getElementById("audio-" + newUser) || createAudioElement(newUser);
            audio.srcObject = stream;
        });
        peers[newUser] = peer;
    });

    socket.on("voice-users", list => {
        list.forEach(u => {
            if (u !== username && !peers[u]) {
                socket.emit("voice-new-user", u);
            }
        });
    });

    socket.on("voice-user-left", user => {
        if (peers[user]) {
            peers[user].destroy();
            delete peers[user];
            const audio = document.getElementById("audio-" + user);
            if (audio) audio.remove();
        }
    });

    document.getElementById("send-btn").disabled = true;
</script>