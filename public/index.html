<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>POSSOUD</title>
    <style>
        body { margin:0; height:100vh; display:flex; font-family:Arial; background:#121212; color:#fff; }
        #channels { width:200px; border-right:1px solid #444; padding:10px; background:#1e1e1e; overflow-y:auto; }
        #chat { flex:1; padding:10px; background:#1a1a1a; display:flex; flex-direction:column; }
        #messages { flex:1; overflow-y:auto; border:1px solid #444; padding:10px; margin-bottom:10px; background:#222; }
        input, select, button { padding:10px; background:#333; color:#fff; border:1px solid #555; border-radius:4px; }
        button { background:#555; cursor:pointer; }
        button:disabled { opacity:0.4; cursor:not-allowed; }
        #voice-controls button { margin:5px; }
        li { cursor:pointer; padding:8px 5px; border-radius:4px; }
        li:hover { background:#333; }
        li.active { font-weight:bold; color:#00acee; background:#333; }
        #send-btn { min-width:100px; }

        /* Mikrofon butonu */
        #mute-btn { background:#c41e3a; }
        #mute-btn.muted { background:#333; color:#ff4444; }
        #mute-btn::before { content:"Mikrofon Açık "; }
        #mute-btn.muted::before { content:"Mikrofon Kapalı "; }

        /* Temizle butonu */
        #clear-btn { background:#c41e3a; }
        #clear-btn:hover { background:#e74c3c !important; }

        /* SESLİ ODADAKİLER PANELİ */
        #voice-members-panel {
            margin-top:20px;
            background:#111;
            border-radius:10px;
            padding:12px;
            border:1px solid #333;
            display:none;
        }
        #voice-members-panel h4 {
            margin:0 0 12px 0;
            color:#00acee;
            font-size:15px;
        }
        .voice-member-item {
            padding:10px;
            background:#222;
            border-radius:8px;
            display:flex;
            align-items:center;
            gap:10px;
            font-size:14px;
            animation: fadeIn 0.3s;
        }
        .voice-member-item.you {
            background:#1e3a2e;
            border-left:4px solid #00ff88;
            font-weight:bold;
        }
        .voice-member-item::before {
            content:"●";
            color:#00ff00;
            font-size:18px;
            animation:pulse 2s infinite;
        }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
        @keyframes fadeIn { from{opacity:0; transform:translateY(-10px)} to{opacity:1; transform:translateY(0)} }
    </style>
</head>
<body>
    <div id="channels"><h3>Kanallar</h3><ul id="channel-list"></ul></div>
    <div id="chat">
        <h3 id="current-channel">Mesajlar</h3>
        <div id="messages"></div>

        <!-- MESAJ GÖNDERME + TEMİZLE BUTONU -->
        <div style="display:flex; gap:5px; flex-wrap:wrap;">
            <input id="msg" placeholder="Mesaj yaz..." style="flex:1;">
            <input id="dm-user" placeholder="DM (opsiyonel)">
            <select id="group-users" multiple size="1" style="width:150px;"></select>
            <button id="send-btn" onclick="send()">Gönder</button>
            <button id="clear-btn">Tümünü Temizle</button>
        </div>

        <div id="voice-controls">
            <button id="start-voice">Sesli Sohbete Katıl</button>
            <button id="stop-voice" disabled>Sohbetten Çık</button>
            <button id="mute-btn" disabled>Mikrofonu Kapat</button>
        </div>

        <!-- SESLİ ODADAKİLER PANELİ -->
        <div id="voice-members-panel">
            <h4>Sesli Odadakiler</h4>
            <div id="voice-members-list"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-peer@9/simplepeer.min.js"></script>
    <script>
        const socket = io();
        const username = prompt("Kullanıcı adını gir:") || "Anonim";
        socket.emit("register", username);

        let currentChannel = null;
        let localStream = null;
        const peers = {};
        let isMuted = false;

        const voicePanel = document.getElementById("voice-members-panel");
        const voiceList = document.getElementById("voice-members-list");
        const muteBtn = document.getElementById("mute-btn");

        // MESAJ SINIRI
        const MAX_MESSAGES = 300;

        function checkMessageLimit() {
            const messagesDiv = document.getElementById("messages");
            while (messagesDiv.children.length > MAX_MESSAGES) {
                messagesDiv.removeChild(messagesDiv.children[0]);
            }
        }

        function createAudioElement(user) {
            const audio = document.createElement("audio");
            audio.id = "audio-" + user;
            audio.autoplay = true;
            document.body.appendChild(audio);
            return audio;
        }

        // Kanal listesi
        fetch('/channels').then(r => r.json()).then(channels => {
            const ul = document.getElementById('channel-list');
            channels.forEach(c => {
                const li = document.createElement('li');
                li.textContent = c.name;
                li.onclick = () => {
                    document.querySelectorAll('#channel-list li').forEach(x => x.classList.remove('active'));
                    li.classList.add('active');
                    currentChannel = c.id;
                    document.getElementById('current-channel').textContent = c.name;
                    document.getElementById('messages').innerHTML = "";
                    socket.emit('joinChannel', currentChannel);
                    document.getElementById('send-btn').disabled = false;
                };
                ul.appendChild(li);
            });
        });

        // Kullanıcı listesi
        setInterval(() => {
            fetch('/users').then(r => r.json()).then(list => {
                const sel = document.getElementById("group-users");
                sel.innerHTML = "";
                list.filter(u => u !== username).forEach(u => {
                    const opt = document.createElement("option");
                    opt.value = opt.textContent = u;
                    sel.appendChild(opt);
                });
            });
        }, 3000);

        // Mesaj gönderme
        function send() {
            const text = document.getElementById("msg").value.trim();
            if (!text || !currentChannel) return;

            const selectedGroup = Array.from(document.getElementById("group-users").selectedOptions).map(o => o.value);
            const dmUser = document.getElementById("dm-user").value.trim() || null;

            const msg = {
                channel: currentChannel,
                text,
                user: username,
                time: new Date().toTimeString().slice(0,5),
                dmUser,
                groupUsers: selectedGroup.length > 0 ? selectedGroup : null
            };

            socket.emit("message", msg);
            document.getElementById("msg").value = "";
            document.getElementById("dm-user").value = "";
            document.getElementById("group-users").selectedIndex = -1;
        }

        document.getElementById("msg").addEventListener("keypress", e => {
            if (e.key === "Enter") { e.preventDefault(); send(); }
        });

        // Tüm mesajları temizle butonu
        document.getElementById("clear-btn").onclick = () => {
            if (confirm("Bütün mesajları silmek istediğine emin misin kanka?")) {
                document.getElementById("messages").innerHTML = "";
            }
        };

        socket.on("message", msg => {
            const isVisible = msg.channel === currentChannel ||
                (msg.dmUser && (msg.dmUser === username || msg.user === username)) ||
                (msg.groupUsers && msg.groupUsers.includes(username));
            if (!isVisible) return;

            const p = document.createElement("p");
            if (msg.groupUsers && msg.groupUsers.length > 0)
                p.textContent = `[${msg.time}] ${msg.user} → ${msg.groupUsers.join(", ")}: ${msg.text}`;
            else if (msg.dmUser)
                p.textContent = `[${msg.time}] ${msg.user} → ${msg.dmUser}: ${msg.text}`;
            else
                p.textContent = `[${msg.time}] ${msg.user}: ${msg.text}`;

            document.getElementById("messages").appendChild(p);
            document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;

            // Otomatik silme
            checkMessageLimit();
        });

        // Sesli odadakiler paneli
        function updateVoiceMembers() {
            voiceList.innerHTML = "";
            const currentVoiceUsers = Object.keys(peers);
            if (currentVoiceUsers.length === 0 && !localStream) {
                voicePanel.style.display = "none";
                return;
            }
            voicePanel.style.display = "block";
            const all = [...new Set([username, ...currentVoiceUsers])].sort();
            all.forEach(u => {
                const div = document.createElement("div");
                div.className = "voice-member-item" + (u === username ? " you" : "");
                div.textContent = u === username ? u + " (Sen)" : u;
                voiceList.appendChild(div);
            });
        }

        // Mikrofon kapat/aç
        muteBtn.onclick = () => {
            if (!localStream) return;
            isMuted = !isMuted;
            localStream.getAudioTracks()[0].enabled = !isMuted;
            if (isMuted) {
                muteBtn.classList.add("muted");
                muteBtn.textContent = "Mikrofonu Aç";
            } else {
                muteBtn.classList.remove("muted");
                muteBtn.textContent = "Mikrofonu Kapat";
            }
        };

        // Sesliye gir
        document.getElementById("start-voice").onclick = async () => {
            if (localStream) return;
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
                });
                socket.emit("voice-join", { username });
                document.getElementById("start-voice").disabled = true;
                document.getElementById("stop-voice").disabled = false;
                document.getElementById("mute-btn").disabled = false;
                muteBtn.classList.remove("muted");
                muteBtn.textContent = "Mikrofonu Kapat";
                isMuted = false;
                updateVoiceMembers();
            } catch (err) {
                alert("Mikrofon erişimi reddedildi!");
            }
        };

        // Sesliden çık
        document.getElementById("stop-voice").onclick = () => {
            if (localStream) {
                localStream.getTracks().forEach(t => t.stop());
                localStream = null;
            }
            Object.keys(peers).forEach(user => {
                if (peers[user]) peers[user].destroy();
                delete peers[user];
                const audio = document.getElementById("audio-" + user);
                if (audio) audio.remove();
            });
            socket.emit("voice-leave");
            document.getElementById("start-voice").disabled = false;
            document.getElementById("stop-voice").disabled = true;
            document.getElementById("mute-btn").disabled = true;
            muteBtn.classList.remove("muted");
            muteBtn.textContent = "Mikrofonu Kapat";
            voicePanel.style.display = "none";
        };

        // WebRTC kısmı (değişmedi)
        socket.on("voice-signal", ({ from, signal }) => {
            if (!peers[from]) {
                const peer = new SimplePeer({ initiator: false, trickle: false, stream: localStream });
                peer.on("signal", data => socket.emit("voice-signal", { to: from, from: username, signal: data }));
                peer.on("stream", stream => {
                    const audio = document.getElementById("audio-" + from) || createAudioElement(from);
                    audio.srcObject = stream;
                });
                peers[from] = peer;
                updateVoiceMembers();
            }
            peers[from].signal(signal);
        });

        socket.on("voice-new-user", newUser => {
            if (!localStream || peers[newUser]) return;
            const peer = new SimplePeer({ initiator: true, trickle: false, stream: localStream });
            peer.on("signal", data => socket.emit("voice-signal", { to: newUser, from: username, signal: data }));
            peer.on("stream", stream => {
                const audio = document.getElementById("audio-" + newUser) || createAudioElement(newUser);
                audio.srcObject = stream;
            });
            peers[newUser] = peer;
            updateVoiceMembers();
        });

        socket.on("voice-users", list => {
            list.forEach(u => {
                if (u !== username && !peers[u]) socket.emit("voice-new-user", u);
            });
            updateVoiceMembers();
        });

        socket.on("voice-user-left", user => {
            if (peers[user]) {
                peers[user].destroy();
                delete peers[user];
                const audio = document.getElementById("audio-" + user);
                if (audio) audio.remove();
            }
            updateVoiceMembers();
        });

        window.addEventListener("beforeunload", () => {
            if (localStream) localStream.getTracks().forEach(t => t.stop());
            socket.emit("voice-leave");
        });

        document.getElementById("send-btn").disabled = true;
    </script>
</body>
</html>